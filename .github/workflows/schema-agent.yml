name: schema-agent

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  plan-migration:
    runs-on: ubuntu-latest
    env:
      MODULE_HINT: app.db.base
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install schema-pilot
        run: |
          python -m pip install --upgrade pip
          python -m pip install git+https://github.com/tarunms7/schema-pilot.git
      - name: Capture head/base
        run: |
          echo "HEAD_PATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          mkdir -p $RUNNER_TEMP/base
          git --work-tree=$RUNNER_TEMP/base checkout ${{ github.event.pull_request.base.sha }} -- .
          echo "BASE_PATH=$RUNNER_TEMP/base" >> $GITHUB_ENV
          # Ensure typical src/ layouts are importable in both trees
          echo "PYTHONPATH=$GITHUB_WORKSPACE:$GITHUB_WORKSPACE/src:$RUNNER_TEMP/base:$RUNNER_TEMP/base/src" >> $GITHUB_ENV
      - name: Run schema-agent
        run: |
          mkdir -p artifacts
          if [ -f "schema-agent.yml" ]; then
            echo "Detected schema-agent.yml → running config-driven mode"
            python -m schema_agent.cli run -c ./schema-agent.yml --out-dir artifacts
          else
            echo "No schema-agent.yml found → falling back to module-hint mode ($MODULE_HINT)"
            python -m schema_agent.cli \
              --base-dir "$BASE_PATH" --base-module "$MODULE_HINT" \
              --head-dir "$HEAD_PATH" --head-module "$MODULE_HINT" \
              --dialect postgresql \
              --out-dir artifacts
          fi
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: schema-agent-sql
          path: |
            artifacts/forward.sql
            artifacts/rollback.sql
      - name: Comment SQL summary to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            function readFileSafe(path) {
              try { return fs.readFileSync(path, 'utf8'); } catch (e) { return ''; }
            }
            const max = 60000; // GH comment body limit ~65k
            const fsql = readFileSafe('artifacts/forward.sql');
            const rsql = readFileSafe('artifacts/rollback.sql');
            const fshow = fsql ? fsql.slice(0, max) + (fsql.length > max ? '\n-- [truncated]' : '') : '-- forward.sql not found';
            const rshow = rsql ? rsql.slice(0, max) + (rsql.length > max ? '\n-- [truncated]' : '') : '-- rollback.sql not found';
            const body = `Schema Agent generated SQL.\n\nForward SQL:\n\n\`\`\`sql\n${fshow}\n\`\`\`\n\nRollback SQL:\n\n\`\`\`sql\n${rshow}\n\`\`\``;
            const { owner, repo } = context.repo;
            await github.rest.issues.createComment({ owner, repo, issue_number: context.issue.number, body });
